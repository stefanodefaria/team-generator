<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de times</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        textarea { width: 100%; }
        #namesInput { height: 400px; }
        #rulesInput { height: 100px; }
        #output { margin-top: 20px; background-color: #f8f9fa; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-center">Gerador de times</h1>

    <div class="form-group">
        <h4 for="teamCountSelect">Número de times</h4>
        <select id="teamCountSelect" class="form-control" selected="3">
            <option value="2">2 times</option>
            <option value="3" selected>3 times</option>
        </select>
    </div>

    <div class="form-group">
        <h4 for="namesInput">Jogadores</h4>
        <textarea id="namesInput" class="form-control" placeholder="Enter names here, one per line.">Smangol
Stéfano
Lucas
Horse
Rodolfo
Paulo
Felipe
Bazza
Marcos
Léo
Marcus
Rafael
Matheus
Anderson
Paulinho</textarea>
    </div>

    <div class="form-group">
        <h4 for="rulesInput">Jogadores que não podem estar no mesmo time</h4>
        <label for="rulesInput">Uma regra por linha</label>
        <textarea id="rulesInput" class="form-control" placeholder="Enter rules here, one per line.">Marcus, Smangol, Lúdico
Paulo, Rodolfo, Felipe
Anderson, Paulinho, Léo</textarea>
    </div>

    <button id="generateTeamsButton" class="btn btn-primary btn-block">Gerar times</button>

    <h2 class="mt-4">Times</h2>
    <pre id="output" class="border rounded p-2"></pre>
</div>

<script>
    function parseInput(input) {
        return input.split('\n').map(name => name.trim());
    }

    function parseRules(input) {
        return input.split('\n').map(rule => rule.split(",").map(player => player.trim()));
    }

    function shuffle(originalArray) {
        const array = JSON.parse(JSON.stringify(originalArray));
        let currentIndex = array.length;
        while (currentIndex !== 0) {
            let randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function isPlayerForbiddenInTeam(team, player, forbiddenInTheSameTeamRules) {
        for (ruleIdx in forbiddenInTheSameTeamRules) {
            const rule = forbiddenInTheSameTeamRules[ruleIdx];

            if (!rule.includes(player)) continue;
            const forbiddenPlayers = new Set();
            forbiddenPlayers.add(player);

            team.filter(p => rule.includes(p)).forEach(p => forbiddenPlayers.add(p));

            if (forbiddenPlayers.size > 1) return true;
        }
        return false;
    }

    function markPlayerAsSelected(shuffledPlayers, player) {
        const index = shuffledPlayers.indexOf(player);
        shuffledPlayers.splice(index, 1);
    }

    function selectTeams(players, rules, teamCount) {
        const playerCountPerTeam = Math.ceil(players.length / teamCount);
        const teams = [];
        const shuffledPlayers = shuffle(players);

        for (let teamIdx = 0; teamIdx < teamCount; teamIdx++) {
            const team = [];
            let playerIdx = 0;
            while (team.length < playerCountPerTeam) {
                const player = shuffledPlayers[playerIdx++];
                if (isPlayerForbiddenInTeam(team, player, rules)) continue;
                team.push(player);
                markPlayerAsSelected(shuffledPlayers, player);
                playerIdx = 0;
            }
            teams.push(team);
        }

        return teams;
    }

    function notAllTeamsAreFull(teams) {
        return teams.find(t => t.includes(undefined)) != null;
    }

    document.getElementById('generateTeamsButton').onclick = function() {
        const namesInput = document.getElementById('namesInput').value;
        const rulesInput = document.getElementById('rulesInput').value;        
        const teamCount = parseInt(document.getElementById('teamCountSelect').value, 10);
        const players = parseInput(namesInput);
        const rules = parseRules(rulesInput);

	let selectedTeams = selectTeams(players, rules, teamCount)
	for(let attempt = 0; attempt < 100 && notAllTeamsAreFull(selectedTeams); attempt++) {
	    selectedTeams = selectTeams(players, rules, teamCount);
	}

        let output = '';
	if (notAllTeamsAreFull(selectedTeams)) {
            output = 'Não foi possível gerar times com as regras fornecidas';
	} else {
            selectedTeams.forEach((team, idx) => {
                output += `Time ${idx + 1}: ${team.join(', ')}\n`;
            });
	}

        document.getElementById('output').textContent = output;
    };
</script>

</body>
</html>

